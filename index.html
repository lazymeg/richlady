
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯Œå©†è¨˜å¸³æœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        touch-action: manipulation;
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; 
            margin: 0;
            background-color: #f2ede7;
            min-height: 100vh;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #root {
            width: 100%;
            min-height: 100vh;
            position: relative;
        }
        .bg-polka {
            background-image: radial-gradient(#d1cdc7 1px, transparent 1px);
            background-size: 20px 20px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useCallback } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'https://esm.sh/recharts@2.12.2?deps=react@18.2.0,react-dom@18.2.0';
        import { 
            X, Plus, Banknote, CreditCard, PieChart, Home, Utensils, ShoppingBag, 
            Briefcase, ChevronDown, TrendingUp, Layers, Calculator, Edit3, Download, Upload, Image as ImageIcon, Trash2, Settings, Eye, EyeOff, Hash, MessageCircle, ArrowRight, Coffee, Wallet, Receipt, PiggyBank, ChevronLeft, ChevronRight, RefreshCw, Equal
        } from 'https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0';

        const INITIAL_BANK_BALANCE_DEFAULT = 0; 
        const BANK_EXPENSE_CATEGORY_DEFAULT = 'ä¿¡ç”¨å¡è²»';
        const STORAGE_KEY = 'rich_lady_ledger_v4'; 

        const DEFAULT_RICH_LADY_IMAGE = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f2ede7'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='10' text-anchor='middle' fill='%232c2c2c'%3Eä¸Šå‚³å¯Œå©†ç…§%3C/text%3E%3C/svg%3E";

        // --- è«è˜­è¿ªè³ªæ„Ÿé…è‰² ---
        const THEME = {
            bg: 'bg-[#f2ede7]', 
            cardBg: 'bg-white',
            text: 'text-[#2c2c2c]',
            border: 'border-[#2c2c2c]',
            shadow: 'shadow-[3px_3px_0px_0px_#2c2c2c]', 
            shadowSm: 'shadow-[2px_2px_0px_0px_#2c2c2c]',
            shadowActive: 'active:translate-y-[2px] active:shadow-[1px_1px_0px_0px_#2c2c2c]',
            income: { main: 'bg-[#a1b89e]', text: 'text-white', border: 'border-[#2c2c2c]', hex: '#a1b89e' }, 
            payment: { main: 'bg-[#f7b7a7]', text: 'text-[#2c2c2c]', border: 'border-[#2c2c2c]', hex: '#f7b7a7' }, 
            daily: { main: 'bg-[#debe51]', text: 'text-[#2c2c2c]', border: 'border-[#2c2c2c]', hex: '#debe51' },
            bank: { main: 'bg-[#7696b8]', text: 'text-white', border: 'border-[#2c2c2c]', hex: '#7696b8' },
        };

        const MOTIVATIONAL_QUOTES = {
            income: ["å“å‘€ï¼éŒ¢åŒ…åˆèƒ–äº†ï¼ŒçœŸå›°æ“¾ï½", "é€™å°±æ˜¯å¯Œå©†çš„æ—¥å¸¸ï¼Œæ”¶éŒ¢æ”¶åˆ°æ‰‹è»Ÿã€‚", "å¸é‡‘é«”è³ªå°±æ˜¯æˆ‘æœ¬äººï¼", "å­˜èµ·ä¾†ï¼Œæ˜¯ç‚ºäº†æ›´è¯éº—çš„æ¶ˆè²»ã€‚"],
            expense: ["è²·ï¼é€™é»å°éŒ¢ï¼Œè²·çš„æ˜¯å¿«æ¨‚ï¼", "å¯Œå©†çš„å­—å…¸è£¡æ²’æœ‰ã€Œå¤ªè²´ã€ï¼Œåªæœ‰ã€Œå€¼å¾—ã€ã€‚", "èŠ±éŒ¢æ˜¯ç‚ºäº†è®“ä¸–ç•Œç¶“æ¿Ÿæµå‹•ï½", "é€™ä¸æ˜¯èŠ±è²»ï¼Œé€™æ˜¯å°ç¾å¥½ç”Ÿæ´»çš„æŠ•è³‡ã€‚"],
            payment: ["ç¹³æ¸…äº†ï¼ç„¡å‚µä¸€èº«è¼•ï¼Œç¹¼çºŒåˆ·ï¼", "ä¿¡ç”¨å°±æ˜¯å¯Œå©†çš„ç¬¬äºŒç”Ÿå‘½ï¼Œé¤Šå¾—å¥½å¥½çš„ã€‚", "å›ºå®šæ”¯å‡ºæå®šï¼Œå‰©ä¸‹çš„éƒ½æ˜¯æˆ‘çš„ï¼"],
            welcome: ["æˆ‘æ˜¯å¯Œå©†ï¼Œæˆ‘æ„›éŒ¢ï¼ŒéŒ¢ä¹Ÿæ„›æˆ‘ã€‚", "ä»Šå¤©ä¹Ÿæ˜¯é©åˆè®Šæœ‰éŒ¢çš„ä¸€å¤©ï¼", "åˆ·çš„ä¸æ˜¯è¼‰å…·ï¼Œæ˜¯æœªä¾†ç™¾è¬çš„ç¬‘å®¹ã€‚"]
        };
        const getRandomQuote = (type) => MOTIVATIONAL_QUOTES[type][Math.floor(Math.random() * MOTIVATIONAL_QUOTES[type].length)];

        const categoryToIcon = (category) => {
            const iconClass = "w-5 h-5";
            if (!category) return <Banknote className={iconClass} />;
            if (category.includes('å¡')) return <CreditCard className={iconClass} />;
            if (category.includes('è–ª') || category.includes('ç') || category.includes('éŒ¢')) return <Banknote className={iconClass} />;
            if (category.includes('åƒ') || category.includes('é£Ÿ') || category.includes('é£²')) return <Utensils className={iconClass} />;
            if (category.includes('ä½') || category.includes('æˆ¿') || category.includes('é›»')) return <Home className={iconClass} />;
            if (category.includes('è²·') || category.includes('è³¼') || category.includes('è¡£')) return <ShoppingBag className={iconClass} />;
            if (category.includes('è»Š') || category.includes('è¡Œ')) return <Briefcase className={iconClass} />;
            if (category.includes('å’–') || category.includes('èŒ¶')) return <Coffee className={iconClass} />;
            return <TrendingUp className={iconClass} />;
        };

        // --- SplashScreen ---
        const SplashScreen = ({ onStart, customImage }) => {
            const quote = useMemo(() => getRandomQuote('welcome'), []);
            
            return (
                <div className="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-[#f2ede7] p-6 animate-in fade-in duration-700 w-full h-full">
                    <div className="absolute inset-0 bg-polka opacity-50 pointer-events-none"></div>
                    
                    <div className="relative z-10 flex flex-col items-center w-full max-w-md mx-auto">
                        <div className={`w-40 h-40 mb-6 rounded-full flex items-center justify-center border-4 ${THEME.border} ${THEME.shadow} bg-white transform hover:scale-110 transition-transform duration-500 cursor-pointer active:rotate-12`}>
                            {customImage ? (
                                <img src={customImage} className="w-full h-full object-cover rounded-full" alt="å¯Œå©†ç…§" />
                            ) : (
                                <Wallet className="w-20 h-20 text-[#f7b7a7]" strokeWidth={2} />
                            )}
                        </div>
                        
                        <h1 className="text-4xl font-black mb-1 tracking-tight text-[#2c2c2c]">RICH LADY</h1>
                        <p className="text-lg font-bold text-[#7696b8] tracking-[0.2em] mb-8">è¶ŠèŠ±è¶Šæœ‰éŒ¢</p>

                        <div className={`relative bg-white border-4 ${THEME.border} p-6 rounded-[2rem] ${THEME.shadow} mb-10 max-w-xs text-center w-full`}>
                            <p className="text-lg font-black text-[#2c2c2c] leading-relaxed">{quote}</p>
                            <div className={`absolute -bottom-4 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[16px] border-b-[#2c2c2c] rotate-180`}></div>
                            <div className={`absolute -bottom-[11px] left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-b-[12px] border-b-white rotate-180`}></div>
                        </div>

                        <button 
                            onClick={onStart}
                            className={`group relative w-full py-4 bg-[#debe51] text-[#2c2c2c] font-black text-xl rounded-2xl border-4 border-[#2c2c2c] shadow-[4px_4px_0px_0px_#2c2c2c] active:translate-y-1 active:shadow-none transition-all flex items-center justify-center gap-2`}
                        >
                            é–‹å§‹è¨˜å¸³ <ArrowRight className="w-6 h-6 group-hover:translate-x-1 transition-transform" />
                        </button>
                        
                        <div className="mt-8 text-xl font-black text-[#2c2c2c]/80 hover:text-[#f7b7a7] transition-colors px-4 py-2 rounded-full">
                            <a href="https://lazymeg.com/m/" target="_blank" className="flex items-center gap-2 justify-center">
                                Designed by meg.dai <ArrowRight className="w-5 h-5" />
                            </a>
                        </div>
                    </div>
                </div>
            );
        };

        const TransactionItem = React.memo(({ transaction, onClick }) => {
            const isIncome = transaction.type === 'income';
            const isBankAffected = transaction.isBankAffected;
            
            let itemStyle;
            let textColorClass = '';
            
            if (isIncome) {
                itemStyle = THEME.income;
                textColorClass = 'text-[#5a7558]'; 
            } else if (isBankAffected) {
                itemStyle = THEME.payment;
                textColorClass = 'text-[#b05f4d]'; 
            } else {
                itemStyle = THEME.daily;
                textColorClass = 'text-[#967d23]'; 
            }

            const amountDisplay = `${isIncome ? '+' : ''} $${transaction.amount.toLocaleString()}`;
            const dateDisplay = new Date(transaction.date).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });

            return (
                <div onClick={() => onClick(transaction)} className={`flex items-center justify-between p-4 mb-3 ${THEME.cardBg} rounded-xl border-2 ${THEME.border} ${THEME.shadowSm} hover:translate-y-[-2px] hover:shadow-[4px_4px_0px_0px_#1a1a1a] transition-all cursor-pointer`}>
                <div className="flex items-center space-x-4">
                    <div className={`p-3 rounded-full border-2 ${THEME.border} ${itemStyle.main} ${itemStyle.text}`}>
                        {categoryToIcon(transaction.category)}
                    </div>
                    <div>
                        <p className={`text-base font-bold ${THEME.text} flex items-center gap-1`}>{transaction.category}</p>
                        <p className="text-xs font-medium text-gray-500">{transaction.description || 'ç„¡å‚™è¨»'}</p>
                    </div>
                </div>
                <div className="text-right">
                    <p className={`text-lg font-black ${textColorClass}`}>{amountDisplay}</p>
                    <div className="flex items-center justify-end gap-1 mt-1">
                        <p className="text-xs font-bold text-gray-400">{dateDisplay}</p>
                        {!isBankAffected && <span className="text-[10px] font-bold bg-[#f9f1d8] text-[#967d23] px-1 rounded border border-[#debe51]">ä¸è¨ˆå…¥</span>}
                    </div>
                </div>
                </div>
            );
        });

        const CalculatorModal = ({ initialValue, onClose, onResult, isAmountMode = false }) => {
            // å¦‚æœæ˜¯é‡‘é¡æ¨¡å¼ï¼Œç”¨å‚³å…¥çš„å€¼ï¼›å¦‚æœæ˜¯ç´”è¨ˆç®—æ©Ÿ(é‡‘åº«)ï¼Œä¸€å¾‹å¾ 0 é–‹å§‹
            const startingValue = isAmountMode ? (initialValue || 0) : 0; 
            const formatValue = (value) => {
                if (value === null) return '0';
                const str = String(value);
                if (str.includes('.')) return str.replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
                return str;
            };
            const [displayValue, setDisplayValue] = useState(isAmountMode ? '0' : formatValue(startingValue));
            const [firstOperand, setFirstOperand] = useState(isAmountMode ? null : startingValue);
            const [operator, setOperator] = useState(null);
            const [waitingForSecondOperand, setWaitingForSecondOperand] = useState(false);

            const performCalculation = (op, secondOperand) => {
                const v1 = Number(firstOperand), v2 = Number(secondOperand);
                if (op === '+') return v1 + v2; if (op === '-') return v1 - v2; if (op === '*') return v1 * v2; if (op === '/') return v2 === 0 ? 'éŒ¯èª¤' : v1 / v2;
                return secondOperand;
            };
            const inputDigit = (digit) => {
                if (waitingForSecondOperand) { setDisplayValue(String(digit)); setWaitingForSecondOperand(false); } 
                else {
                    const isInit = displayValue === '0';
                    setDisplayValue(isInit ? String(digit) : displayValue + digit);
                }
            };
            const handleOperator = (nextOp) => {
                const inputVal = Number(displayValue);
                if (operator && waitingForSecondOperand) { setOperator(nextOp); return; }
                if (firstOperand === null) setFirstOperand(inputVal);
                else if (operator) {
                    const result = performCalculation(operator, inputVal);
                    setDisplayValue(formatValue(result)); setFirstOperand(result);
                }
                setWaitingForSecondOperand(true); setOperator(nextOp);
            };
            const handleEquals = () => {
                if (!operator && !isAmountMode) return;
                const inputValue = Number(displayValue);
                let result = inputValue;
                
                if (operator) result = performCalculation(operator, inputValue);
                
                if(isAmountMode) { 
                    if (onResult) onResult(result); 
                    onClose(); 
                } 
                else { 
                    setDisplayValue(formatValue(result)); 
                    setFirstOperand(result); 
                    setOperator(null); 
                    setWaitingForSecondOperand(false); 
                }
            };
            const btnBase = `p-4 rounded-xl text-xl font-black ${THEME.border} border-2 ${THEME.shadowSm} ${THEME.shadowActive} transition-all flex items-center justify-center`;

            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className={`w-full max-w-sm ${THEME.bg} rounded-3xl p-6 relative animate-in zoom-in duration-300 border-4 ${THEME.border} ${THEME.shadow}`}>
                        <button onClick={onClose} className={`absolute top-4 right-4 p-1 hover:bg-gray-200 rounded-full border-2 border-transparent hover:${THEME.border} transition`}><X className="w-6 h-6" /></button>
                        <h2 className={`text-2xl font-black ${THEME.text} mb-4 border-b-4 ${THEME.border} pb-2 inline-block`}>{isAmountMode ? 'é‡‘é¡é€Ÿç®—' : 'éš¨æ‰‹ç®—'}</h2>
                        <div className={`bg-[#2c2c2c] text-[#debe51] p-4 mb-4 rounded-xl text-right font-mono border-4 ${THEME.border} shadow-inner`}>
                            <p className="text-xs text-gray-400 mb-1">{isAmountMode ? 'ç›®å‰æ•¸å€¼' : 'è¨ˆç®—çµæœ'}</p>
                            <p className="text-4xl tracking-wider truncate">{displayValue}</p>
                        </div>
                        <div className="grid grid-cols-4 gap-3">
                            <button onClick={() => { setDisplayValue('0'); setFirstOperand(null); setOperator(null); }} className={`${btnBase} bg-[#f7b7a7] text-[#2c2c2c]`}>C</button>
                            {['/', '*', '-'].map(op => <button key={op} onClick={() => handleOperator(op)} className={`${btnBase} bg-white`}>{op}</button>)}
                            {[7, 8, 9].map(num => <button key={num} onClick={() => inputDigit(num)} className={`${btnBase} bg-white`}>{num}</button>)}
                            <button onClick={() => handleOperator('+')} className={`${btnBase} bg-white row-span-2 h-full`}>+</button>
                            {[4, 5, 6, 1, 2, 3].map(num => <button key={num} onClick={() => inputDigit(num)} className={`${btnBase} bg-white`}>{num}</button>)}
                            <button onClick={() => inputDigit(0)} className={`${btnBase} bg-white col-span-2`}>0</button>
                            <button onClick={handleEquals} className={`${btnBase} ${isAmountMode?'bg-green-500':'bg-[#2E86C1]'} text-white col-span-1`}>{isAmountMode ? 'OK' : '='}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ data, updateData, onClose }) => {
            const [newCatInput, setNewCatInput] = useState('');
            const [activeTab, setActiveTab] = useState('income'); 
            const [statusMsg, setStatusMsg] = useState('');
            const [localBalance, setLocalBalance] = useState(data.settings.initialBalance);

            const handleSaveBalance = () => {
                updateData({ ...data, settings: { ...data.settings, initialBalance: parseFloat(localBalance) } });
                setStatusMsg('é¤˜é¡å·²æ›´æ–°'); setTimeout(() => setStatusMsg(''), 2000);
            };
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        updateData({ ...data, settings: { ...data.settings, customImage: reader.result } });
                        setStatusMsg('æ’åœ–æ›´æ–°æˆåŠŸï¼'); setTimeout(() => setStatusMsg(''), 2000);
                    };
                    reader.readAsDataURL(file);
                }
            };
            const modifyCategory = (action, key, val) => {
                const typeMap = { income: 'incomeCategories', bankExpense: 'bankExpenseCategories', expense: 'expenseCategories' };
                const field = typeMap[activeTab];
                const newCats = { ...data.settings[field] };
                if (action === 'add') newCats[`cat_${Date.now()}`] = val;
                else delete newCats[key];
                updateData({ ...data, settings: { ...data.settings, [field]: newCats } });
                setNewCatInput('');
            };
            const handleExport = () => {
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href = url; a.download = `rich_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };
            const handleImport = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => { try { const p = JSON.parse(evt.target.result); if(p.settings) { updateData(p); setStatusMsg('é‚„åŸæˆåŠŸï¼'); } } catch(e) { setStatusMsg('éŒ¯èª¤'); } };
                reader.readAsText(file);
            };

            // æ–°å¢é‡ç½®åŠŸèƒ½
            const handleReset = () => {
                if(window.confirm("ğŸš¨ è­¦å‘Šï¼šç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿé€™å‹•ä½œç„¡æ³•å¾©åŸï¼")) {
                    localStorage.removeItem(STORAGE_KEY);
                    window.location.reload(); 
                }
            };

            const tabClass = (tab) => `flex-1 py-2 font-bold text-sm border-b-4 transition ${activeTab === tab ? `border-[#2c2c2c] text-[#2c2c2c]` : 'border-transparent text-gray-400'}`;

            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className={`w-full max-w-lg ${THEME.bg} rounded-3xl p-6 relative animate-in zoom-in border-4 ${THEME.border} ${THEME.shadow} max-h-[90vh] overflow-y-auto`}>
                        <button onClick={onClose} className="absolute top-4 right-4"><X /></button>
                        <h2 className="text-2xl font-black mb-6">âš™ï¸ è¨­å®šä¸­å¿ƒ</h2>
                        {statusMsg && <div className="bg-[#a1b89e] text-white p-2 rounded-lg mb-4 font-bold text-center border-2 border-[#2c2c2c]">{statusMsg}</div>}
                        
                        <div className="flex mb-6 border-b-2 border-gray-300 overflow-x-auto">
                            {['income', 'bankExpense', 'expense', 'image', 'backup'].map(t => 
                                <button key={t} onClick={() => setActiveTab(t)} className={tabClass(t)}>{t==='income'?'æ”¶å…¥':t==='bankExpense'?'ç¹³è²»':t==='expense'?'æ—¥å¸¸':t==='image'?'æ’åœ–':'å‚™ä»½'}</button>
                            )}
                        </div>

                        {activeTab === 'image' && (
                            <div className="text-center">
                                <div className={`w-32 h-32 mx-auto mb-4 bg-white rounded-full border-4 ${THEME.border} overflow-hidden flex items-center justify-center shadow-inner`}>
                                    {/* è¨­å®šé é¢ä¹Ÿä½¿ç”¨ customImage ç‹€æ…‹ */}
                                    {data.settings.customImage ? 
                                        <img src={data.settings.customImage} className="w-full h-full object-cover" /> : 
                                        <ImageIcon className="w-12 h-12 text-gray-400" />
                                    }
                                </div>
                                <div className="flex gap-2 justify-center">
                                    <label className={`inline-block px-4 py-3 bg-[#2c2c2c] text-white font-bold rounded-xl cursor-pointer hover:bg-gray-800 transition ${THEME.shadowSm} ${THEME.shadowActive} border-2 border-transparent text-sm`}>
                                        ä¸Šå‚³ <input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" />
                                    </label>
                                </div>
                                <p className="text-xs text-gray-500 mt-3">é€™å¼µåœ–æœƒç”¨åœ¨è¨˜å¸³å¾Œçš„é¼“å‹µç•«é¢å–”ï¼</p>
                            </div>
                        )}

                        {/* å‚™ä»½èˆ‡é‡ç½®å€å¡Š */}
                        {activeTab === 'backup' && (
                            <div className="space-y-4">
                                <button onClick={handleExport} className={`w-full p-4 bg-white text-[#2c2c2c] font-bold rounded-xl border-2 ${THEME.border} flex items-center justify-center gap-2 ${THEME.shadowSm} ${THEME.shadowActive}`}><Download/> ä¸‹è¼‰å‚™ä»½</button>
                                <label className={`w-full p-4 bg-[#2c2c2c] text-white font-bold rounded-xl flex items-center justify-center gap-2 cursor-pointer ${THEME.shadowSm} ${THEME.shadowActive}`}><Upload/> é‚„åŸå‚™ä»½ <input type="file" onChange={handleImport} className="hidden" /></label>
                                
                                <div className="pt-4 border-t-2 border-gray-300">
                                    <button onClick={handleReset} className={`w-full p-3 bg-[#f7b7a7] text-[#2c2c2c] font-bold rounded-xl border-2 ${THEME.border} ${THEME.shadowSm} ${THEME.shadowActive} flex items-center justify-center gap-2`}>
                                        <RefreshCw size={20} /> é‡ç½®é‡‘åº« (æ¸…é™¤æ‰€æœ‰è³‡æ–™)
                                    </button>
                                </div>
                            </div>
                        )}

                        {['income','expense','bankExpense'].includes(activeTab) && (
                            <div>
                                <div className="mb-4 flex gap-2">
                                    <input value={newCatInput} onChange={(e) => setNewCatInput(e.target.value)} placeholder="æ–°åˆ†é¡..." className={`flex-1 p-3 border-2 ${THEME.border} rounded-xl font-medium`} />
                                    <button onClick={() => newCatInput.trim() && modifyCategory('add', null, newCatInput.trim())} className={`p-3 bg-[#2c2c2c] text-white rounded-xl font-bold ${THEME.shadowActive}`}><Plus/></button>
                                </div>
                                <div className="space-y-2 max-h-40 overflow-y-auto">
                                    {Object.entries(data.settings[activeTab === 'income' ? 'incomeCategories' : activeTab === 'bankExpense' ? 'bankExpenseCategories' : 'expenseCategories']).map(([k, v]) => (
                                        <div key={k} className={`flex justify-between items-center p-3 bg-white border-2 ${THEME.border} rounded-xl`}><span className="font-bold">{v}</span><button onClick={() => modifyCategory('remove', k)} className="text-red-500"><Trash2/></button></div>
                                    ))}
                                </div>
                                {/* ç§»åˆ° income é ç±¤åº•éƒ¨çš„åˆå§‹é¤˜é¡è¨­å®š */}
                                {activeTab === 'income' && (
                                    <div className="mt-6 pt-4 border-t-2 border-gray-200">
                                        <label className="block text-xs font-bold text-gray-500 mb-2">åˆå§‹é‡‘åº«é¤˜é¡ (æ ¡æ­£ç”¨)</label>
                                        <div className="flex gap-2">
                                            <input type="number" value={localBalance} onChange={(e) => setLocalBalance(e.target.value)} className={`flex-1 p-3 border-2 ${THEME.border} rounded-xl font-mono font-bold`} />
                                            <button onClick={handleSaveBalance} className={`p-3 bg-[#a1b89e] text-white rounded-xl font-bold border-2 ${THEME.border} ${THEME.shadowActive}`}>å„²å­˜</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const TransactionModal = ({ initialData, onSave, onDelete, onClose, categories }) => {
            const isEditing = !!initialData;
            const getInitialTab = () => {
                if (!initialData) return 'income';
                if (initialData.type === 'income') return 'income';
                if (initialData.isBankAffected && initialData.type === 'expense') return 'payment';
                return 'expense';
            };
            const [amount, setAmount] = useState(initialData ? initialData.amount.toString() : '');
            const [category, setCategory] = useState(initialData ? initialData.category : '');
            const [description, setDescription] = useState(initialData ? initialData.description : '');
            const [date, setDate] = useState(initialData ? new Date(initialData.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]);
            const [currentTab, setCurrentTab] = useState(getInitialTab());
            const [isCalOpen, setIsCalOpen] = useState(false);

            const currentCats = currentTab === 'income' ? categories.income : (currentTab === 'payment' ? categories.bank : categories.expense);
            const catList = Object.values(currentCats);
            useEffect(() => { if (!category || !catList.includes(category)) setCategory(catList[0]); }, [currentTab, catList]);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (!amount || isNaN(parseFloat(amount))) return;
                onSave({
                    id: initialData ? initialData.id : Date.now().toString(),
                    amount: parseFloat(amount),
                    category: category || catList[0],
                    description,
                    date: new Date(date).toISOString(),
                    currentTab
                });
            };
            const tabStyle = (tab, colorBg, colorText) => `flex-1 py-3 rounded-xl font-black transition-all border-2 ${THEME.border} ${currentTab === tab ? `${colorBg} ${colorText} ${THEME.shadowSm} -translate-y-1` : 'bg-white text-gray-400 border-transparent'}`;

            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className={`w-full max-w-md ${THEME.bg} rounded-[2rem] p-6 relative border-4 ${THEME.border} ${THEME.shadow} animate-in zoom-in`}>
                        <button onClick={onClose} className="absolute top-4 right-4 hover:bg-gray-200 p-2 rounded-full transition"><X/></button>
                        <h2 className={`text-2xl font-black ${THEME.text} mb-6 text-center`}>{isEditing ? 'ç·¨è¼¯' : 'è¨˜ä¸€ç­†'}</h2>
                        <div className="flex gap-2 bg-[#e0dbd5] p-2 rounded-2xl mb-6 border-2 border-[#d1d1d1]">
                            <button onClick={() => setCurrentTab('income')} className={tabStyle('income', THEME.income.main, THEME.income.text)}>æ”¶å…¥</button>
                            <button onClick={() => setCurrentTab('payment')} className={tabStyle('payment', THEME.payment.main, THEME.payment.text)}>ç¹³è²»</button>
                            <button onClick={() => setCurrentTab('expense')} className={tabStyle('expense', THEME.daily.main, THEME.daily.text)}>æ—¥å¸¸ (ä¸è¨ˆ)</button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="relative">
                                <label className="block text-xs font-bold text-gray-500 mb-1 ml-1">é‡‘é¡</label>
                                <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className={`w-full p-4 text-3xl font-black border-4 ${THEME.border} rounded-2xl focus:outline-none focus:ring-4 ring-[#debe51]`} placeholder="0"/>
                                <button type="button" onClick={() => setIsCalOpen(true)} className={`absolute right-3 top-7 p-2 bg-white rounded-lg border-2 ${THEME.border}`}><Calculator size={20}/></button>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-xs font-bold text-gray-500 mb-1 ml-1">æ—¥æœŸ</label><input type="date" value={date} onChange={e => setDate(e.target.value)} className={`w-full p-3 border-2 ${THEME.border} rounded-xl font-bold`} /></div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1 ml-1">é¡åˆ¥</label><div className="relative"><select value={category} onChange={e => setCategory(e.target.value)} className={`w-full p-3 border-2 ${THEME.border} rounded-xl font-bold appearance-none bg-white`}>{catList.map(c => <option key={c} value={c}>{c}</option>)}</select><ChevronDown className="absolute right-3 top-3.5 pointer-events-none" size={16}/></div></div>
                            </div>
                            <div><label className="block text-xs font-bold text-gray-500 mb-1 ml-1">å‚™è¨»</label><input type="text" value={description} onChange={e => setDescription(e.target.value)} className={`w-full p-3 border-2 ${THEME.border} rounded-xl font-bold`} placeholder="..." /></div>
                            
                            {currentTab === 'expense' && <p className="text-xs font-bold text-[#debe51] text-center">â€» æ—¥å¸¸æ”¯å‡ºåªåšç´€éŒ„ï¼Œä¸æ‰£é™¤é‡‘åº«é¤˜é¡</p>}

                            <div className="flex gap-3 pt-2">
                                {isEditing && <button type="button" onClick={() => { if(window.confirm('åˆªé™¤ï¼Ÿ')) onDelete(initialData.id); }} className={`p-4 bg-white text-[#f7b7a7] rounded-xl border-2 border-[#f7b7a7] ${THEME.shadowActive}`}><Trash2/></button>}
                                <button type="submit" className={`flex-1 p-4 bg-[#2c2c2c] text-white rounded-xl font-black text-lg shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] ${THEME.shadowActive} transition-all`}>{isEditing ? 'ä¿å­˜' : 'ç¢ºèª'}</button>
                            </div>
                        </form>
                    </div>
                    {isCalOpen && <CalculatorModal initialValue={Number(amount)} onClose={() => setIsCalOpen(false)} onResult={res => { setAmount(res); setIsCalOpen(false); }} isAmountMode={true} />}
                </div>
            );
        };

        const MotivationalPopup = ({ message, onClose, customImage }) => {
            useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            return (
                <div className="fixed inset-0 z-[100] flex items-end justify-center pointer-events-none absolute-center-container">
                    <div className="absolute inset-0 bg-[#f2ede7]/80 backdrop-blur-sm animate-in fade-in duration-300"></div>
                    <div className="relative z-10 mb-0 w-full max-w-md px-6 flex flex-col items-center animate-in slide-in-from-bottom-20 duration-500 pointer-events-auto" onClick={onClose}>
                        <div className="relative flex flex-col items-center transform rotate-1 hover:scale-105 transition-transform duration-300">
                            <div className={`relative bg-white border-4 ${THEME.border} p-6 rounded-[2rem] ${THEME.shadow} w-72 text-center z-20 mb-[-20px]`}>
                                <p className={`text-xl font-black ${THEME.text} leading-relaxed`}>{message}</p>
                                <div className={`absolute -bottom-4 left-1/2 transform -translate-x-1/2 w-8 h-8 bg-white border-b-4 border-r-4 ${THEME.border} rotate-45`}></div>
                            </div>
                            <div className="relative w-64 h-64 z-10">
                                <img src={customImage || DEFAULT_RICH_LADY_IMAGE} alt="Rich Woman" className="w-full h-full object-contain drop-shadow-xl" />
                            </div>
                        </div>
                        <p className="mt-4 text-gray-400 font-bold text-sm tracking-widest mb-10 animate-pulse">é»æ“Šé—œé–‰</p>
                    </div>
                </div>
            );
        };

        const App = () => {
            const defaultData = {
                settings: {
                    initialBalance: INITIAL_BANK_BALANCE_DEFAULT,
                    incomeCategories: { c1: 'è–ªæ°´', c2: 'çé‡‘', c3: 'æŠ•è³‡' },
                    expenseCategories: { e1: 'åƒå–', e2: 'ç”Ÿæ´»ç”¨å“', e3: 'å·¥ä½œ' },
                    bankExpenseCategories: { b1: BANK_EXPENSE_CATEGORY_DEFAULT, b2: 'æˆ¿ç§Ÿ' },
                    customImage: null
                },
                transactions: []
            };

            const [data, setData] = useState(defaultData);
            const [isLoaded, setIsLoaded] = useState(false);
            const [showSplash, setShowSplash] = useState(true); 
            const [viewMode, setViewMode] = useState('list');
            const [modals, setModals] = useState({ setting: false, add: false, edit: null, cal: false, msg: null });
            const [showBalance, setShowBalance] = useState(false);
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));

            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) { 
                    try { setData(JSON.parse(saved)); } catch (e) { console.error(e); } 
                }
                setIsLoaded(true);
            }, []);

            useEffect(() => { 
                if (isLoaded) localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); 
            }, [data, isLoaded]);

            const changeMonth = (delta) => {
                const [year, month] = selectedMonth.split('-').map(Number);
                const date = new Date(year, month - 1 + delta, 1);
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                setSelectedMonth(`${y}-${m}`);
            };

            const { bankBalance, totalIncome, totalExpense, netSavings, chartData } = useMemo(() => {
                let bal = data.settings.initialBalance;
                let tInc = 0, tExp = 0;
                const monthMap = new Map();

                data.transactions.forEach(t => {
                    const month = t.date.slice(0, 7);
                    if (!monthMap.has(month)) monthMap.set(month, { income: 0, expense: 0, month: month.replace('-', '/') });
                    const mData = monthMap.get(month);

                    if (t.type === 'income') {
                        if (t.isBankAffected) bal += t.amount;
                    } else {
                        if (t.isBankAffected) bal -= t.amount;
                    }

                    if (month === selectedMonth) {
                        if (t.type === 'income') tInc += t.amount;
                        else tExp += t.amount;
                    }
                    
                    if (t.type === 'income') mData.income += t.amount;
                    else mData.expense += t.amount;
                });
                return { bankBalance: bal, totalIncome: tInc, totalExpense: tExp, netSavings: tInc - tExp, chartData: Array.from(monthMap.values()).sort((a, b) => a.month.localeCompare(b.month)) };
            }, [data, selectedMonth]); 

            const handleStart = () => {
                setShowSplash(false);
                if (data.settings.initialBalance === INITIAL_BANK_BALANCE_DEFAULT && data.transactions.length === 0) {
                    setModals(p => ({ ...p, setting: true }));
                }
            };

            const handleSaveTrans = (newTrans) => {
                const type = newTrans.currentTab === 'income' ? 'income' : 'expense';
                const isBankAffected = newTrans.currentTab !== 'expense'; 
                const transObj = { ...newTrans, type, isBankAffected };
                
                const newTransactions = data.transactions.filter(t => t.id !== transObj.id).concat(transObj).sort((a, b) => new Date(b.date) - new Date(a.date));
                setData(prev => ({ ...prev, transactions: newTransactions }));
                
                setModals(prev => ({ ...prev, add: false, edit: null }));
                if (!data.transactions.find(t => t.id === transObj.id)) {
                    const qType = newTrans.currentTab === 'income' ? 'income' : (newTrans.currentTab === 'payment' ? 'payment' : 'expense');
                    setModals(prev => ({ ...prev, msg: getRandomQuote(qType) }));
                }
            };

            const handleDeleteTrans = (id) => {
                setData(prev => ({ ...prev, transactions: prev.transactions.filter(t => t.id !== id) }));
                setModals(prev => ({ ...prev, edit: null }));
            };

            if (!isLoaded) return null;

            if (showSplash) return <SplashScreen onStart={handleStart} customImage={data.settings.customImage} />;

            return (
                <div className={`font-sans pb-24 text-gray-800 h-full w-full overflow-y-auto bg-[#f2ede7]`}>
                    <div className="pt-8 px-6 pb-4 flex justify-between items-center max-w-screen-md mx-auto">
                        <div><h1 className={`text-3xl font-black tracking-tight ${THEME.text}`}>RICH LADY</h1><p className="text-sm font-bold text-gray-400 tracking-widest">è¶ŠèŠ±è¶Šæœ‰éŒ¢</p></div>
                        <div className="flex gap-3">
                            <button onClick={() => setViewMode(viewMode === 'list' ? 'chart' : 'list')} className={`p-3 bg-[#f2ede7]/80 border-2 ${THEME.border} rounded-xl ${THEME.shadowSm} ${THEME.shadowActive} transition-all`}>
                                <ResponsiveContainer size={20}>{viewMode === 'list' ? <PieChart/> : <Layers/>}</ResponsiveContainer>
                            </button>
                            <button onClick={() => setModals(p => ({...p, setting: true}))} className={`p-3 bg-[#2c2c2c] text-white rounded-xl ${THEME.shadowSm} ${THEME.shadowActive}`}><Settings size={20}/></button>
                        </div>
                    </div>

                    <div className="px-6 mb-6 max-w-screen-md mx-auto">
                        <div onClick={() => setModals(p=>({...p, cal: true}))} className={`relative p-6 ${THEME.bank.main} rounded-[2rem] border-4 ${THEME.border} ${THEME.shadow} cursor-pointer group overflow-hidden`}>
                            <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10"></div>
                            <div className="relative z-10">
                                <div className="flex justify-between items-start mb-2"><p className="text-blue-100 font-bold tracking-wider text-sm">é‡‘åº«ç¸½é¡</p><Hash className="text-blue-200 w-5 h-5 group-hover:rotate-12 transition-transform" /></div>
                                <div className="flex items-baseline gap-3"><h2 className="text-4xl font-black text-white tracking-tighter">{showBalance ? `$${bankBalance.toLocaleString()}` : '****'}</h2><button onClick={(e) => { e.stopPropagation(); setShowBalance(!showBalance); }} className="p-1 text-blue-200 hover:text-white">{showBalance ? <EyeOff size={20}/> : <Eye size={20}/>}</button></div>
                            </div>
                        </div>
                    </div>

                    <div className="px-6 mb-4 flex justify-between items-center max-w-screen-md mx-auto">
                        <button onClick={() => changeMonth(-1)} className={`p-2 bg-white border-2 ${THEME.border} rounded-lg ${THEME.shadowSm}`}><ChevronLeft size={20}/></button>
                        <span className="font-black text-xl text-[#2c2c2c] tracking-widest">{selectedMonth}</span>
                        <button onClick={() => changeMonth(1)} className={`p-2 bg-white border-2 ${THEME.border} rounded-lg ${THEME.shadowSm}`}><ChevronRight size={20}/></button>
                    </div>

                    <div className="grid grid-cols-3 gap-3 px-6 mb-8 max-w-screen-md mx-auto">
                        <div className={`p-3 ${THEME.income.main} rounded-2xl border-2 ${THEME.border} ${THEME.shadowSm}`}><p className="text-xs font-bold mb-1 opacity-80 text-[#2c2c2c]">æœ¬æœˆæ”¶å…¥</p><p className="font-black text-lg leading-none text-[#2c2c2c]">+${totalIncome.toLocaleString()}</p></div>
                        <div className={`p-3 ${THEME.payment.main} rounded-2xl border-2 ${THEME.border} ${THEME.shadowSm}`}><p className="text-xs font-bold text-[#2c2c2c] mb-1 opacity-90">æœ¬æœˆæ”¯å‡º</p><p className="font-black text-lg leading-none text-[#2c2c2c]">-${totalExpense.toLocaleString()}</p></div>
                        <div className={`p-3 bg-white rounded-2xl border-2 ${THEME.border} ${THEME.shadowSm}`}><p className="text-xs font-bold text-gray-400 mb-1">æœ¬æœˆæ·¨é¤˜</p><p className={`font-black text-lg leading-none ${netSavings >= 0 ? 'text-[#a1b89e]' : 'text-[#f7b7a7]'}`}>{netSavings >= 0 ? '+' : ''}{netSavings.toLocaleString()}</p></div>
                    </div>

                    <div className="px-6 max-w-screen-md mx-auto">
                        {viewMode === 'list' ? (
                            <div className="space-y-3">
                                <h3 className={`font-black text-xl mb-4 flex items-center gap-2 ${THEME.text}`}><span className="bg-[#2c2c2c] text-white px-2 py-1 text-sm rounded-md rotate-2">HISTORY</span> å¸³å‹™ç´€éŒ„</h3>
                                {data.transactions.filter(t => t.date.startsWith(selectedMonth)).length === 0 ? 
                                <div className="text-center py-10 opacity-50">
                                    <p className="text-6xl mb-4">ğŸ›‹ï¸</p>
                                    <p className="font-bold text-lg">èººå¹³å°±èƒ½è®Šå¯Œå©†ï¼Ÿ<br/>å…ˆè¨˜ä¸‹ä¸€ç­†å†èªªï¼</p>
                                </div> 
                                : data.transactions.filter(t => t.date.startsWith(selectedMonth)).map(t => <TransactionItem key={t.id} transaction={t} onClick={(item) => setModals(p => ({...p, edit: item}))} />)}
                            </div>
                        ) : (
                            <div className={`bg-white p-4 rounded-3xl border-4 ${THEME.border} h-80 ${THEME.shadow}`}>
                                <ResponsiveContainer width="100%" height="100%"><BarChart data={chartData}><CartesianGrid strokeDasharray="3 3" vertical={false} /><XAxis dataKey="month" tick={{fontSize: 10}} axisLine={false} tickLine={false} /><YAxis hide /><Tooltip cursor={{fill: '#f3f4f6'}} contentStyle={{borderRadius: '12px', border: '2px solid #2c2c2c', boxShadow: '4px 4px 0 #2c2c2c'}} /><Legend /><Bar dataKey="income" name="æ”¶å…¥" fill={THEME.income.hex} radius={[4,4,0,0]} /><Bar dataKey="expense" name="æ”¯å‡º" fill={THEME.payment.hex} radius={[4,4,0,0]} /></BarChart></ResponsiveContainer>
                            </div>
                        )}
                    </div>

                    <button onClick={() => setModals(p => ({...p, add: true}))} className={`fixed bottom-8 right-6 w-16 h-16 bg-[#2c2c2c] text-white rounded-full flex items-center justify-center shadow-[4px_4px_0px_0px_rgba(0,0,0,0.3)] hover:scale-110 hover:rotate-90 transition-all duration-300 z-40 border-4 border-white`}><Plus size={32} strokeWidth={3} /></button>

                    <div className="text-center mt-8 pb-4 text-xs font-bold text-gray-400 hover:text-[#f7b7a7] transition-colors">
                        <a href="https://lazymeg.com/m/" target="_blank" className="inline-flex items-center gap-1">Designed by meg.dai</a>
                    </div>

                    {modals.msg && <MotivationalPopup message={modals.msg} customImage={data.settings.customImage} onClose={() => setModals(p => ({...p, msg: null}))} />}
                    {(modals.add || modals.edit) && <TransactionModal initialData={modals.edit} onClose={() => setModals(p => ({...p, add: false, edit: null}))} onSave={handleSaveTrans} onDelete={handleDeleteTrans} categories={{income: data.settings.incomeCategories, expense: data.settings.expenseCategories, bank: data.settings.bankExpenseCategories}} />}
                    {modals.setting && <SettingsModal data={data} updateData={setData} onClose={() => setModals(p => ({...p, setting: false}))} />}
                    {modals.cal && <CalculatorModal initialValue={0} onClose={() => setModals(p => ({...p, cal: false}))} />}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>