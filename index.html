<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¯Œå©†è¨˜å¸³æœ¬</title>
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. è¼‰å…¥ Babel (è§£æ React) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        touch-action: manipulation;
        body { 
            -webkit-tap-highlight-color: transparent; 
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; 
            margin: 0;
            background-color: #f2ede7;
            min-height: 100vh;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        #root {
            width: 100%;
            min-height: 100vh;
            position: relative;
        }
        .bg-polka {
            background-image: radial-gradient(#d1cdc7 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .recharts-tooltip-wrapper { outline: none; }
        /* è¼‰å…¥ç•«é¢æ¨£å¼ */
        #loader {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #f2ede7; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column; color: #2c2c2c; font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- é è¨­é¡¯ç¤ºè¼‰å…¥ä¸­ï¼ŒReact å•Ÿå‹•å¾Œæœƒè¦†è“‹é€™è£¡ -->
    <div id="root">
        <div id="loader">
            <p style="font-size: 24px;">ğŸ’</p>
            <p>æ­£åœ¨ç‚ºå¯Œå©†é‹ªç´…åœ°æ¯¯...</p>
        </div>
    </div>

    <!-- éŒ¯èª¤æ•æ‰è…³æœ¬ -->
    <script>
        window.onerror = function(msg, url, line) {
            const loader = document.getElementById('loader');
            if(loader) loader.innerHTML = `<p style="color:red; text-align:center; padding:20px;">ğŸ˜± ç™¼ç”ŸéŒ¯èª¤äº†ï¼<br/>è«‹æˆªåœ–çµ¦å·¥ç¨‹å¸«ï¼š<br/><br/>${msg}<br/>Line: ${line}</p>`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo, useCallback } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { ComposedChart, Bar, Line, XAxis, YAxis, CartesianGrid, Tooltip as RechartsTooltip, Legend, ResponsiveContainer, LabelList } from 'https://esm.sh/recharts@2.12.2?deps=react@18.2.0,react-dom@18.2.0';
        import { 
            X, Plus, Banknote, CreditCard, PieChart as PieIcon, Home, Utensils, ShoppingBag, 
            Briefcase, ChevronDown, TrendingUp, Layers, Calculator, Edit3, Download, Upload, Image as ImageIcon, Trash2, Settings, Eye, EyeOff, Hash, MessageCircle, ArrowRight, Coffee, Wallet, Receipt, PiggyBank, ChevronLeft, ChevronRight, RefreshCw, Equal, Save, Filter, Trophy, Sparkles, NotebookPen, Instagram, AlertCircle
        } from 'https://esm.sh/lucide-react@0.344.0?deps=react@18.2.0';

        const INITIAL_BANK_BALANCE_DEFAULT = 0; 
        
        // é€™æ˜¯ç›®å‰çš„æœ€æ–°ç‰ˆæœ¬ Key
        const STORAGE_KEY = 'rich_lady_ledger_v10_final'; 

        // é€™æ˜¯æ‰€æœ‰èˆŠç‰ˆæœ¬çš„ Keyï¼Œç”¨æ–¼è‡ªå‹•æ¬å®¶
        const LEGACY_KEYS = [
            'rich_lady_ledger_v9_final',
            'rich_lady_ledger_v8_diary',
            'rich_lady_ledger_v7_cash',
            'rich_lady_ledger_v6_final',
            'rich_lady_ledger_v5'
        ];

        const DEFAULT_RICH_LADY_IMAGE = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%23f2ede7'/%3E%3Ctext x='50' y='50' font-family='Arial' font-size='10' text-anchor='middle' fill='%232c2c2c'%3Eä¸Šå‚³å¯Œå©†ç…§%3C/text%3E%3C/svg%3E";

        const THEME = {
            bg: 'bg-[#f2ede7]', cardBg: 'bg-white', text: 'text-[#2c2c2c]', border: 'border-[#2c2c2c]',
            shadow: 'shadow-[3px_3px_0px_0px_#2c2c2c]', shadowSm: 'shadow-[2px_2px_0px_0px_#2c2c2c]',
            shadowActive: 'active:translate-y-[2px] active:shadow-[1px_1px_0px_0px_#2c2c2c]',
            income: { main: 'bg-[#a1b89e]', text: 'text-white', border: 'border-[#2c2c2c]', hex: '#a1b89e' }, 
            payment: { main: 'bg-[#f7b7a7]', text: 'text-[#2c2c2c]', border: 'border-[#2c2c2c]', hex: '#f7b7a7' }, 
            daily: { main: 'bg-[#debe51]', text: 'text-[#2c2c2c]', border: 'border-[#2c2c2c]', hex: '#debe51' },
            bank: { main: 'bg-[#7696b8]', text: 'text-white', border: 'border-[#2c2c2c]', hex: '#7696b8' },
        };
        const PIE_COLORS = ['#f7b7a7', '#debe51', '#a1b89e', '#7696b8', '#e0dbd5', '#2c2c2c'];

        const MOTIVATIONAL_QUOTES = {
            income: ["å“å‘€ï¼éŒ¢åŒ…åˆèƒ–äº†ï¼ŒçœŸå›°æ“¾ï½", "é€™å°±æ˜¯å¯Œå©†çš„æ—¥å¸¸ï¼Œæ”¶éŒ¢æ”¶åˆ°æ‰‹è»Ÿã€‚", "å¸é‡‘é«”è³ªå°±æ˜¯æˆ‘æœ¬äººï¼", "å­˜èµ·ä¾†ï¼Œæ˜¯ç‚ºäº†æ›´è¯éº—çš„æ¶ˆè²»ã€‚"],
            expense: ["è²·ï¼é€™é»å°éŒ¢ï¼Œè²·çš„æ˜¯å¿«æ¨‚ï¼", "å¯Œå©†çš„å­—å…¸è£¡æ²’æœ‰ã€Œå¤ªè²´ã€ï¼Œåªæœ‰ã€Œå€¼å¾—ã€ã€‚", "èŠ±éŒ¢æ˜¯ç‚ºäº†è®“ä¸–ç•Œç¶“æ¿Ÿæµå‹•ï½", "é€™ä¸æ˜¯èŠ±è²»ï¼Œé€™æ˜¯å°ç¾å¥½ç”Ÿæ´»çš„æŠ•è³‡ã€‚"],
            payment: ["ç¹³æ¸…äº†ï¼ç„¡å‚µä¸€èº«è¼•ï¼Œç¹¼çºŒåˆ·ï¼", "ä¿¡ç”¨å°±æ˜¯å¯Œå©†çš„ç¬¬äºŒç”Ÿå‘½ï¼Œé¤Šå¾—å¥½å¥½çš„ã€‚", "å›ºå®šæ”¯å‡ºæå®šï¼Œå‰©ä¸‹çš„éƒ½æ˜¯æˆ‘çš„ï¼"],
            welcome: ["æˆ‘æ˜¯å¯Œå©†ï¼Œæˆ‘æ„›éŒ¢ï¼ŒéŒ¢ä¹Ÿæ„›æˆ‘ã€‚", "ä»Šå¤©ä¹Ÿæ˜¯é©åˆè®Šæœ‰éŒ¢çš„ä¸€å¤©ï¼", "æˆ‘è¨˜çš„ä¸æ˜¯èŠ±è²»ï¼Œæ˜¯æœªä¾†ç™¾è¬çš„ç¬‘å®¹ã€‚"]
        };
        const getRandomQuote = (type) => MOTIVATIONAL_QUOTES[type][Math.floor(Math.random() * MOTIVATIONAL_QUOTES[type].length)];

        const categoryToIcon = (category) => {
            const iconClass = "w-5 h-5";
            if (!category) return <Banknote className={iconClass} />;
            if (category.includes('å¡')) return <CreditCard className={iconClass} />;
            if (category.includes('è–ª') || category.includes('ç') || category.includes('éŒ¢') || category.includes('æŠ•') || category.includes('ä»–')) return <Banknote className={iconClass} />;
            if (category.includes('åƒ') || category.includes('é£Ÿ') || category.includes('é£²')) return <Utensils className={iconClass} />;
            if (category.includes('ä½') || category.includes('æˆ¿') || category.includes('é›»') || category.includes('å›º')) return <Home className={iconClass} />;
            if (category.includes('è²·') || category.includes('è³¼') || category.includes('è¡£') || category.includes('è³')) return <ShoppingBag className={iconClass} />;
            if (category.includes('è»Š') || category.includes('è¡Œ')) return <Briefcase className={iconClass} />;
            if (category.includes('å’–') || category.includes('èŒ¶')) return <Coffee className={iconClass} />;
            return <NotebookPen className={iconClass} />;
        };

        // --- æ–°å¢ï¼šç‰ˆæœ¬æ›´æ–°é€šçŸ¥ Modal ---
        const UpdateNoticeModal = ({ onClose, onBackup }) => {
            return (
                <div className="fixed inset-0 z-[300] flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-in fade-in">
                    <div className={`w-full max-w-md bg-white rounded-[2rem] p-6 relative border-4 ${THEME.border} shadow-2xl text-center`}>
                        <div className="w-20 h-20 bg-[#debe51] rounded-full flex items-center justify-center mx-auto mb-4 border-4 border-[#2c2c2c] -mt-12">
                            <Sparkles className="w-10 h-10 text-[#2c2c2c]" />
                        </div>
                        <h2 className="text-2xl font-black text-[#2c2c2c] mb-2">ç³»çµ±æ›´æ–°é€šçŸ¥</h2>
                        <p className="text-gray-600 font-bold mb-6 leading-relaxed">
                            è¦ªæ„›çš„å¯Œå©†ï¼Œæˆ‘å€‘åµæ¸¬åˆ°æ‚¨æœ‰èˆŠç‰ˆæœ¬çš„å¸³æœ¬è³‡æ–™ï¼Œ<br/>
                            ç³»çµ±å·²ç¶“è‡ªå‹•å¹«æ‚¨ <span className="text-[#b05f4d] underline">æ¬å®¶æˆåŠŸ</span> å›‰ï¼ğŸ‰
                        </p>
                        
                        <div className="bg-[#f2ede7] p-4 rounded-xl border-2 border-[#d1cdc7] mb-6 text-left text-sm">
                            <p className="font-bold text-[#2c2c2c] mb-1">ğŸ’¡ å»ºè­°æ“ä½œï¼š</p>
                            <p className="text-gray-500">ç‚ºäº†ç¢ºä¿è³‡æ–™è¬ç„¡ä¸€å¤±ï¼Œå»ºè­°æ‚¨ç¾åœ¨å…ˆä¸‹è¼‰ä¸€ä»½å‚™ä»½æª”æ¡ˆã€‚</p>
                        </div>

                        <div className="space-y-3">
                            <button onClick={onBackup} className="w-full py-4 bg-[#2c2c2c] text-white font-black rounded-xl shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                                <Download size={20}/> ä¸‹è¼‰å‚™ä»½ (æ¨è–¦)
                            </button>
                            <button onClick={onClose} className="w-full py-3 text-gray-400 font-bold hover:text-[#2c2c2c] transition-colors">
                                æˆ‘çŸ¥é“äº†ï¼Œç›´æ¥é–‹å§‹
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const SplashScreen = ({ onStart, customImage }) => {
            const quote = useMemo(() => getRandomQuote('welcome'), []);
            return (
                <div className="fixed inset-0 z-[200] flex flex-col items-center justify-center bg-[#f2ede7] animate-in fade-in duration-700 w-full h-full overflow-hidden">
                    
                    {/* èƒŒæ™¯åœ–èª¿æ•´ï¼šé å·¦ä¸‹ã€2/3é«˜åº¦ã€é€æ˜åº¦ä½ */}
                    <div className="absolute inset-x-0 bottom-0 h-[65%] z-0 pointer-events-none opacity-30">
                        <img src="bg.jpg" className="w-full h-full object-cover object-left-bottom mask-gradient" onError={(e) => e.target.style.display='none'} alt="background" />
                        {/* æ¼¸å±¤é®ç½©è®“é ‚éƒ¨æ·¡å‡º */}
                        <div className="absolute inset-0 bg-gradient-to-b from-[#f2ede7] via-transparent to-transparent"></div>
                    </div>

                    <div className="absolute inset-0 bg-polka opacity-20 pointer-events-none z-0"></div>

                    <div className="relative z-10 flex flex-col items-center w-full max-w-md mx-auto p-6 mt-[-100px]">
                        <div className={`w-40 h-40 mb-6 rounded-full flex items-center justify-center border-4 ${THEME.border} shadow-2xl bg-white transform hover:scale-110 transition-transform duration-500 cursor-pointer active:rotate-12`}>
                            {customImage ? <img src={customImage} className="w-full h-full object-cover rounded-full" alt="å¯Œå©†ç…§" /> : <Wallet className="w-20 h-20 text-[#f7b7a7]" strokeWidth={2} />}
                        </div>
                        {/* å­—é«”é¡è‰²æ”¹ç‚ºç²‰è‰² #f7b7a7 */}
                        <h1 className="text-4xl font-black mb-1 tracking-tight text-[#f7b7a7] drop-shadow-sm stroke-text">RICH LADY</h1>
                        <p className="text-lg font-bold text-[#5a758a] tracking-[0.2em] mb-8">å¯Œå©†è¨˜å¸³æœ¬ è¶ŠèŠ±è¶Šæœ‰éŒ¢</p>
                        
                        <div className={`relative bg-white/95 border-4 ${THEME.border} p-6 rounded-[2rem] shadow-xl mb-12 max-w-xs text-center w-full backdrop-blur-sm`}>
                            <p className="text-lg font-black text-[#2c2c2c] leading-relaxed">{quote}</p>
                            <div className={`absolute -bottom-4 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[10px] border-l-transparent border-r-[10px] border-r-transparent border-b-[16px] border-b-[#2c2c2c] rotate-180`}></div>
                            <div className={`absolute -bottom-[11px] left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-b-[12px] border-b-white rotate-180`}></div>
                        </div>
                        
                        <button onClick={onStart} className={`group relative w-auto px-10 py-4 bg-[#2c2c2c] text-[#debe51] font-black text-lg rounded-full border-4 border-[#debe51] shadow-[0px_10px_20px_rgba(0,0,0,0.25)] active:scale-95 active:shadow-sm transition-all flex items-center justify-center gap-3 tracking-wider hover:bg-black`}>
                           <Sparkles className="w-5 h-5 animate-pulse"/> âœ¨ é–‹å•Ÿå¯Œå©†è¨˜å¸³æ¨¡å¼
                        </button>
                    </div>
                </div>
            );
        };

        const TransactionItem = React.memo(({ transaction, onClick }) => {
            const isIncome = transaction.type === 'income';
            const isBankAffected = transaction.isBankAffected;
            let itemStyle, textColorClass = '';
            if (isIncome) { itemStyle = THEME.income; textColorClass = 'text-[#5a7558]'; } 
            else if (isBankAffected) { itemStyle = THEME.payment; textColorClass = 'text-[#b05f4d]'; } 
            else { itemStyle = THEME.daily; textColorClass = 'text-[#967d23]'; }
            
            const amountDisplay = `${isIncome ? '+' : '-'} $${transaction.amount.toLocaleString()}`;
            const dateDisplay = new Date(transaction.date).toLocaleDateString('zh-TW', { month: '2-digit', day: '2-digit' });

            return (
                <div onClick={() => onClick(transaction)} className={`flex items-center justify-between p-4 mb-3 ${THEME.cardBg} rounded-xl border-2 ${THEME.border} ${THEME.shadowSm} hover:translate-y-[-2px] hover:shadow-[4px_4px_0px_0px_#1a1a1a] transition-all cursor-pointer`}>
                <div className="flex items-center space-x-4">
                    <div className={`p-3 rounded-full border-2 ${THEME.border} ${itemStyle.main} ${itemStyle.text}`}>{categoryToIcon(transaction.category)}</div>
                    <div><p className={`text-base font-bold ${THEME.text} flex items-center gap-1`}>{transaction.category}</p><p className="text-xs font-medium text-gray-500">{transaction.description || 'ç„¡å‚™è¨»'}</p></div>
                </div>
                <div className="text-right">
                    <p className={`text-lg font-black ${textColorClass}`}>{amountDisplay}</p>
                    <div className="flex items-center justify-end gap-1 mt-1">
                        <p className="text-xs font-bold text-gray-400">{dateDisplay}</p>
                        {!isBankAffected && <span className="text-[10px] font-bold bg-[#f9f1d8] text-[#967d23] px-1 rounded border border-[#debe51]">éš¨æ‰‹è¨˜</span>}
                    </div>
                </div>
                </div>
            );
        });

        const CalculatorModal = ({ initialValue, onClose, onResult, isAmountMode = false }) => {
            const startingValue = isAmountMode ? (initialValue || 0) : 0; 
            const formatValue = (value) => {
                if (value === null) return '0';
                const str = String(value);
                if (str.includes('.')) return str.replace(/(\.\d*?)0+$/, '$1').replace(/\.$/, '');
                return str;
            };
            const [displayValue, setDisplayValue] = useState(isAmountMode ? '0' : formatValue(startingValue));
            const [firstOperand, setFirstOperand] = useState(isAmountMode ? null : startingValue);
            const [operator, setOperator] = useState(null);
            const [waitingForSecondOperand, setWaitingForSecondOperand] = useState(false);
            const performCalculation = (op, secondOperand) => {
                const v1 = Number(firstOperand), v2 = Number(secondOperand);
                if (op === '+') return v1 + v2; if (op === '-') return v1 - v2; if (op === '*') return v1 * v2; if (op === '/') return v2 === 0 ? 'éŒ¯èª¤' : v1 / v2;
                return secondOperand;
            };
            const inputDigit = (digit) => {
                if (waitingForSecondOperand) { setDisplayValue(String(digit)); setWaitingForSecondOperand(false); } 
                else { const isInit = displayValue === '0'; setDisplayValue(isInit ? String(digit) : displayValue + digit); }
            };
            const handleOperator = (nextOp) => {
                const inputVal = Number(displayValue);
                if (operator && waitingForSecondOperand) { setOperator(nextOp); return; }
                if (firstOperand === null) setFirstOperand(inputVal);
                else if (operator) { const result = performCalculation(operator, inputVal); setDisplayValue(formatValue(result)); setFirstOperand(result); }
                setWaitingForSecondOperand(true); setOperator(nextOp);
            };
            const handleEquals = () => {
                if (!operator && !isAmountMode) return;
                const inputValue = Number(displayValue);
                let result = inputValue;
                if (operator) result = performCalculation(operator, inputValue);
                if(isAmountMode) { if (onResult) onResult(result); onClose(); } 
                else { setDisplayValue(formatValue(result)); setFirstOperand(result); setOperator(null); setWaitingForSecondOperand(false); }
            };
            const btnBase = `p-4 rounded-xl text-xl font-black ${THEME.border} border-2 ${THEME.shadowSm} ${THEME.shadowActive} transition-all flex items-center justify-center`;
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className={`w-full max-w-sm ${THEME.bg} rounded-3xl p-6 relative animate-in zoom-in duration-300 border-4 ${THEME.border} ${THEME.shadow}`}>
                        <button onClick={onClose} className={`absolute top-4 right-4 p-1 hover:bg-gray-200 rounded-full border-2 border-transparent hover:${THEME.border} transition`}><X className="w-6 h-6" /></button>
                        <h2 className={`text-2xl font-black ${THEME.text} mb-4 border-b-4 ${THEME.border} pb-2 inline-block`}>{isAmountMode ? 'é‡‘é¡é€Ÿç®—' : 'éš¨æ‰‹ç®—'}</h2>
                        <div className={`bg-[#2c2c2c] text-[#debe51] p-4 mb-4 rounded-xl text-right font-mono border-4 ${THEME.border} shadow-inner`}>
                            <p className="text-xs text-gray-400 mb-1">{isAmountMode ? 'ç›®å‰æ•¸å€¼' : 'è¨ˆç®—çµæœ'}</p>
                            <p className="text-4xl tracking-wider truncate">{displayValue}</p>
                        </div>
                        <div className="grid grid-cols-4 gap-3">
                            <button onClick={() => { setDisplayValue('0'); setFirstOperand(null); setOperator(null); }} className={`${btnBase} bg-[#f7b7a7] text-[#2c2c2c]`}>C</button>
                            {['/', '*', '-'].map(op => <button key={op} onClick={() => handleOperator(op)} className={`${btnBase} bg-white`}>{op}</button>)}
                            {[7, 8, 9].map(num => <button key={num} onClick={() => inputDigit(num)} className={`${btnBase} bg-white`}>{num}</button>)}
                            <button onClick={() => handleOperator('+')} className={`${btnBase} bg-white row-span-2 h-full`}>+</button>
                            {[4, 5, 6, 1, 2, 3].map(num => <button key={num} onClick={() => inputDigit(num)} className={`${btnBase} bg-white`}>{num}</button>)}
                            <button onClick={() => inputDigit(0)} className={`${btnBase} bg-white col-span-2`}>0</button>
                            <button onClick={handleEquals} className={`${btnBase} ${isAmountMode?'bg-green-500':'bg-[#2E86C1]'} text-white col-span-1`}>{isAmountMode ? 'OK' : '='}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const BackupModal = ({ data, updateData, onClose }) => {
            const [statusMsg, setStatusMsg] = useState('');
            const handleExport = () => {
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); 
                a.href = url; a.download = `å¯Œå©†å¸³æœ¬_å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                setStatusMsg('æ‰“åŒ…æˆåŠŸï¼æª”æ¡ˆå·²ä¸‹è¼‰');
            };
            const handleImport = (e) => {
                const file = e.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => { 
                    try { const p = JSON.parse(evt.target.result); 
                        if(p.settings && p.transactions) { updateData(p); setStatusMsg('ç¹¼æ‰¿æˆåŠŸï¼è³‡æ–™å·²é‚„åŸ'); setTimeout(onClose, 1500); } 
                        else { setStatusMsg('éŒ¯èª¤ï¼šé€™ä¸æ˜¯å¯Œå©†å¸³æœ¬çš„æª”æ¡ˆï¼'); }
                    } catch(e) { setStatusMsg('éŒ¯èª¤ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢º'); } 
                };
                reader.readAsText(file);
            };
            const handleReset = () => {
                if(window.confirm("ğŸš¨ è­¦å‘Šï¼šç¢ºå®šè¦ã€ŒéŠ·æ¯€ã€æ‰€æœ‰å¸³æœ¬ç´€éŒ„å—ï¼Ÿ")) {
                    localStorage.removeItem(STORAGE_KEY); window.location.reload(); 
                }
            };
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className={`w-full max-w-md ${THEME.bg} rounded-[2rem] p-6 relative animate-in zoom-in border-4 ${THEME.border} ${THEME.shadow}`}>
                        <button onClick={onClose} className="absolute top-4 right-4 hover:bg-gray-200 p-2 rounded-full transition"><X/></button>
                        <div className="text-center mb-6">
                            <div className="inline-flex p-4 bg-[#7696b8] rounded-full border-4 border-[#2c2c2c] mb-3 shadow-lg"><Save className="w-10 h-10 text-white" /></div>
                            <h2 className="text-2xl font-black text-[#2c2c2c]">é‡‘åº«ä¿éšªç®±</h2>
                        </div>
                        {statusMsg && <div className="bg-[#a1b89e] text-white p-3 rounded-xl mb-4 font-bold text-center border-2 border-[#2c2c2c] animate-pulse">{statusMsg}</div>}
                        <div className="space-y-4">
                            <button onClick={handleExport} className={`group w-full p-5 bg-white text-[#2c2c2c] font-black text-lg rounded-2xl border-4 ${THEME.border} flex items-center justify-between ${THEME.shadow} ${THEME.shadowActive} transition-all`}>
                                <div className="flex items-center gap-3"><Download className="w-6 h-6 text-[#7696b8]" /><span>æ‰“åŒ…å¸¶èµ° (ä¸‹è¼‰)</span></div>
                                <ArrowRight className="w-5 h-5 opacity-0 group-hover:opacity-100 transition-opacity" />
                            </button>
                            <label className={`group w-full p-5 bg-[#2c2c2c] text-white font-black text-lg rounded-2xl border-4 ${THEME.border} flex items-center justify-between cursor-pointer ${THEME.shadow} ${THEME.shadowActive} transition-all`}>
                                <div className="flex items-center gap-3"><Upload className="w-6 h-6 text-[#debe51]" /><span>ç¹¼æ‰¿å®¶ç”¢ (è®€å–)</span></div>
                                <input type="file" onChange={handleImport} className="hidden" />
                            </label>
                            <div className="pt-6 mt-6 border-t-2 border-dashed border-gray-300">
                                <button onClick={handleReset} className="w-full py-3 text-red-400 font-bold hover:text-red-600 flex items-center justify-center gap-2 text-sm transition-colors"><RefreshCw size={16} /> éŠ·æ¯€æ‰€æœ‰ç´€éŒ„ (é‡ç½®)</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ data, updateData, onClose }) => {
            const [newCatInput, setNewCatInput] = useState('');
            const [activeTab, setActiveTab] = useState('income'); 
            const [statusMsg, setStatusMsg] = useState('');
            const [localBalance, setLocalBalance] = useState(data.settings.initialBalance);
            const handleSaveBalance = () => {
                updateData({ ...data, settings: { ...data.settings, initialBalance: parseFloat(localBalance) } });
                setStatusMsg('é¤˜é¡å·²æ›´æ–°'); setTimeout(() => setStatusMsg(''), 2000);
            };
            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        updateData({ ...data, settings: { ...data.settings, customImage: reader.result } });
                        setStatusMsg('æ’åœ–æ›´æ–°æˆåŠŸï¼'); setTimeout(() => setStatusMsg(''), 2000);
                    };
                    reader.readAsDataURL(file);
                }
            };
            const modifyCategory = (action, key, val) => {
                const typeMap = { income: 'incomeCategories', bankExpense: 'bankExpenseCategories', expense: 'expenseCategories' };
                const field = typeMap[activeTab];
                const newCats = { ...data.settings[field] };
                if (action === 'add') newCats[`cat_${Date.now()}`] = val;
                else delete newCats[key];
                updateData({ ...data, settings: { ...data.settings, [field]: newCats } });
                setNewCatInput('');
            };
            const tabClass = (tab) => `flex-1 py-2 font-bold text-sm border-b-4 transition ${activeTab === tab ? `border-[#2c2c2c] text-[#2c2c2c]` : 'border-transparent text-gray-400'}`;
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className={`w-full max-w-lg ${THEME.bg} rounded-3xl p-6 relative animate-in zoom-in border-4 ${THEME.border} ${THEME.shadow} max-h-[90vh] overflow-y-auto`}>
                        <button onClick={onClose} className="absolute top-4 right-4"><X /></button>
                        <h2 className="text-2xl font-black mb-6">âš™ï¸ è¨­å®šä¸­å¿ƒ</h2>
                        {statusMsg && <div className="bg-[#a1b89e] text-white p-2 rounded-lg mb-4 font-bold text-center border-2 border-[#2c2c2c]">{statusMsg}</div>}
                        <div className="flex mb-6 border-b-2 border-gray-300 overflow-x-auto">
                            {['income', 'bankExpense', 'expense', 'image'].map(t => 
                                <button key={t} onClick={() => setActiveTab(t)} className={tabClass(t)}>{t==='income'?'æ”¶å…¥':t==='bankExpense'?'ç¹³è²»':t==='expense'?'éš¨æ‰‹è¨˜':t==='image'?'æ’åœ–':t}</button>
                            )}
                        </div>
                        {activeTab === 'image' && (
                            <div className="text-center">
                                <div className={`w-32 h-32 mx-auto mb-4 bg-white rounded-full border-4 ${THEME.border} overflow-hidden flex items-center justify-center shadow-inner`}>
                                    {data.settings.customImage ? <img src={data.settings.customImage} className="w-full h-full object-cover" /> : <ImageIcon className="w-12 h-12 text-gray-400" />}
                                </div>
                                <div className="flex gap-2 justify-center">
                                    <label className={`inline-block px-4 py-3 bg-[#2c2c2c] text-white font-bold rounded-xl cursor-pointer hover:bg-gray-800 transition ${THEME.shadowSm} ${THEME.shadowActive} border-2 border-transparent text-sm`}>
                                        ä¸Šå‚³ <input type="file" accept="image/*" onChange={handleImageUpload} className="hidden" />
                                    </label>
                                </div>
                            </div>
                        )}
                        {['income','expense','bankExpense'].includes(activeTab) && (
                            <div>
                                <div className="mb-4 flex gap-2">
                                    <input value={newCatInput} onChange={(e) => setNewCatInput(e.target.value)} placeholder="æ–°åˆ†é¡..." className={`flex-1 p-3 border-2 ${THEME.border} rounded-xl font-medium`} />
                                    <button onClick={() => newCatInput.trim() && modifyCategory('add', null, newCatInput.trim())} className={`p-3 bg-[#2c2c2c] text-white rounded-xl font-bold ${THEME.shadowActive}`}><Plus/></button>
                                </div>
                                <div className="space-y-2 max-h-40 overflow-y-auto">
                                    {Object.entries(data.settings[activeTab === 'income' ? 'incomeCategories' : activeTab === 'bankExpense' ? 'bankExpenseCategories' : 'expenseCategories']).map(([k, v]) => (
                                        <div key={k} className={`flex justify-between items-center p-3 bg-white border-2 ${THEME.border} rounded-xl`}><span className="font-bold">{v}</span><button onClick={() => modifyCategory('remove', k)} className="text-red-500"><Trash2/></button></div>
                                    ))}
                                </div>
                                {activeTab === 'income' && (
                                    <div className="mt-6 pt-4 border-t-2 border-gray-200">
                                        <label className="block text-xs font-bold text-gray-500 mb-2">åˆå§‹é‡‘åº«é¤˜é¡ (æ ¡æ­£ç”¨)</label>
                                        <div className="flex gap-2">
                                            <input type="number" value={localBalance} onChange={(e) => setLocalBalance(e.target.value)} className={`flex-1 p-3 border-2 ${THEME.border} rounded-xl font-mono font-bold`} />
                                            <button onClick={handleSaveBalance} className={`p-3 bg-[#a1b89e] text-white rounded-xl font-bold border-2 ${THEME.border} ${THEME.shadowActive}`}>å„²å­˜</button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const TransactionModal = ({ initialData, onSave, onDelete, onClose, categories }) => {
            const isEditing = !!initialData;
            const getInitialTab = () => {
                if (!initialData) return 'income';
                if (initialData.type === 'income') return 'income';
                if (initialData.isBankAffected && initialData.type === 'expense') return 'payment';
                return 'expense';
            };
            const [amount, setAmount] = useState(initialData ? initialData.amount.toString() : '');
            const [category, setCategory] = useState(initialData ? initialData.category : '');
            const [description, setDescription] = useState(initialData ? initialData.description : '');
            const [date, setDate] = useState(initialData ? new Date(initialData.date).toISOString().split('T')[0] : new Date().toISOString().split('T')[0]);
            const [currentTab, setCurrentTab] = useState(getInitialTab());
            const [isCalOpen, setIsCalOpen] = useState(false);
            const currentCats = currentTab === 'income' ? categories.income : (currentTab === 'payment' ? categories.bank : categories.expense);
            const catList = Object.values(currentCats);
            useEffect(() => { if (!category || !catList.includes(category)) setCategory(catList[0]); }, [currentTab, catList]);
            const handleSubmit = (e) => {
                e.preventDefault();
                if (!amount || isNaN(parseFloat(amount))) return;
                onSave({
                    id: initialData ? initialData.id : Date.now().toString(),
                    amount: parseFloat(amount),
                    category: category || catList[0],
                    description,
                    date: new Date(date).toISOString(),
                    currentTab
                });
            };
            const tabStyle = (tab, colorBg, colorText) => `flex-1 py-3 rounded-xl font-black transition-all border-2 ${THEME.border} ${currentTab === tab ? `${colorBg} ${colorText} ${THEME.shadowSm} -translate-y-1` : 'bg-white text-gray-400 border-transparent'}`;
            return (
                <div className="fixed inset-0 z-[150] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
                    <div className={`w-full max-w-md ${THEME.bg} rounded-[2rem] p-6 relative border-4 ${THEME.border} ${THEME.shadow} animate-in zoom-in`}>
                        <button onClick={onClose} className="absolute top-4 right-4 hover:bg-gray-200 p-2 rounded-full transition"><X/></button>
                        <h2 className={`text-2xl font-black ${THEME.text} mb-6 text-center`}>{isEditing ? 'ç·¨è¼¯' : 'è¨˜ä¸€ç­†'}</h2>
                        <div className="flex gap-2 bg-[#e0dbd5] p-2 rounded-2xl mb-6 border-2 border-[#d1d1d1]">
                            <button onClick={() => setCurrentTab('income')} className={tabStyle('income', THEME.income.main, THEME.income.text)}>æ”¶å…¥</button>
                            <button onClick={() => setCurrentTab('payment')} className={tabStyle('payment', THEME.payment.main, THEME.payment.text)}>ç¹³è²»</button>
                            <button onClick={() => setCurrentTab('expense')} className={tabStyle('expense', THEME.daily.main, THEME.daily.text)}>éš¨æ‰‹è¨˜</button>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div className="relative">
                                <label className="block text-xs font-bold text-gray-500 mb-1 ml-1">é‡‘é¡</label>
                                <input type="number" value={amount} onChange={e => setAmount(e.target.value)} className={`w-full p-4 text-3xl font-black border-4 ${THEME.border} rounded-2xl focus:outline-none focus:ring-4 ring-[#debe51]`} placeholder="0"/>
                                <button type="button" onClick={() => setIsCalOpen(true)} className={`absolute right-3 top-7 p-2 bg-white rounded-lg border-2 ${THEME.border}`}><Calculator size={20}/></button>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div><label className="block text-xs font-bold text-gray-500 mb-1 ml-1">æ—¥æœŸ</label><input type="date" value={date} onChange={e => setDate(e.target.value)} className={`w-full p-3 border-2 ${THEME.border} rounded-xl font-bold`} /></div>
                                <div><label className="block text-xs font-bold text-gray-500 mb-1 ml-1">é¡åˆ¥</label><div className="relative"><select value={category} onChange={e => setCategory(e.target.value)} className={`w-full p-3 border-2 ${THEME.border} rounded-xl font-bold appearance-none bg-white`}>{catList.map(c => <option key={c} value={c}>{c}</option>)}</select><ChevronDown className="absolute right-3 top-3.5 pointer-events-none" size={16}/></div></div>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-gray-500 mb-1 ml-1">{currentTab === 'expense' ? 'èªªæ˜ (æ—¥è¨˜)' : 'èªªæ˜'}</label>
                                <input type="text" value={description} onChange={e => setDescription(e.target.value)} className={`w-full p-3 border-2 ${THEME.border} rounded-xl font-bold`} placeholder={currentTab === 'expense' ? "ä»Šå¤©ç™¼ç”Ÿäº†ä»€éº¼æœ‰è¶£çš„äº‹ï¼Ÿ" : "..."} />
                            </div>
                            
                            {currentTab === 'expense' && <p className="text-xs font-bold text-[#debe51] text-center">è¶Šè¨˜è¶Šå¯Œæœ‰ ä»Šå¤©ä¹Ÿæ˜¯é©åˆæœ‰éŒ¢çš„ä¸€å¤© â€» ä¸å½±éŸ¿é‡‘åº«ç¸½è³‡ç”¢</p>}

                            <div className="flex gap-3 pt-2">
                                {isEditing && <button type="button" onClick={() => { if(window.confirm('åˆªé™¤ï¼Ÿ')) onDelete(initialData.id); }} className={`p-4 bg-white text-[#f7b7a7] rounded-xl border-2 border-[#f7b7a7] ${THEME.shadowActive}`}><Trash2/></button>}
                                <button type="submit" className={`flex-1 p-4 bg-[#2c2c2c] text-white rounded-xl font-black text-lg shadow-[4px_4px_0px_0px_rgba(0,0,0,0.2)] ${THEME.shadowActive} transition-all`}>{isEditing ? 'ä¿å­˜' : 'ç¢ºèª'}</button>
                            </div>
                        </form>
                    </div>
                    {isCalOpen && <CalculatorModal initialValue={Number(amount)} onClose={() => setIsCalOpen(false)} onResult={res => { setAmount(res); setIsCalOpen(false); }} isAmountMode={true} />}
                </div>
            );
        };

        const MotivationalPopup = ({ message, onClose, customImage }) => {
            useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
            return (
                <div className="fixed inset-0 z-[100] flex items-end justify-center pointer-events-none absolute-center-container">
                    <div className="absolute inset-0 bg-[#f2ede7]/80 backdrop-blur-sm animate-in fade-in duration-300"></div>
                    <div className="relative z-10 mb-0 w-full max-w-md px-6 flex flex-col items-center animate-in slide-in-from-bottom-20 duration-500 pointer-events-auto" onClick={onClose}>
                        <div className="relative flex flex-col items-center transform rotate-1 hover:scale-105 transition-transform duration-300">
                            <div className={`relative bg-white border-4 ${THEME.border} p-6 rounded-[2rem] ${THEME.shadow} w-72 text-center z-20 mb-[-20px]`}>
                                <p className={`text-xl font-black ${THEME.text} leading-relaxed`}>{message}</p>
                                <div className={`absolute -bottom-4 left-1/2 transform -translate-x-1/2 w-8 h-8 bg-white border-b-4 border-r-4 ${THEME.border} rotate-45`}></div>
                            </div>
                            <div className="relative w-64 h-64 z-10">
                                <img src={customImage || DEFAULT_RICH_LADY_IMAGE} alt="Rich Woman" className="w-full h-full object-contain drop-shadow-xl" />
                            </div>
                        </div>
                        <p className="mt-4 text-gray-400 font-bold text-sm tracking-widest mb-10 animate-pulse">é»æ“Šé—œé–‰</p>
                    </div>
                </div>
            );
        };

        const App = () => {
            const defaultData = {
                settings: {
                    initialBalance: INITIAL_BANK_BALANCE_DEFAULT,
                    incomeCategories: { c1: 'è–ªæ°´', c2: 'çé‡‘', c3: 'æŠ•è³‡', c4: 'å…¶ä»–' },
                    expenseCategories: { e1: 'åƒå–', e2: 'ç”Ÿæ´»ç”¨å“', e3: 'å·¥ä½œ' },
                    bankExpenseCategories: { b1: 'ä¿¡ç”¨å¡', b2: 'å›ºå®šæ”¯å‡º', b3: 'æ‰“è³' },
                    customImage: null
                },
                transactions: []
            };
            const [data, setData] = useState(defaultData);
            const [isLoaded, setIsLoaded] = useState(false);
            const [showSplash, setShowSplash] = useState(true); 
            const [viewMode, setViewMode] = useState('list');
            const [modals, setModals] = useState({ setting: false, add: false, edit: null, cal: false, msg: null, backup: false, updateNotice: false });
            const [showBalance, setShowBalance] = useState(false);
            const [selectedMonth, setSelectedMonth] = useState(new Date().toISOString().slice(0, 7));
            const [filterType, setFilterType] = useState('all'); 

            // --- è‡ªå‹•æ¬å®¶é‚è¼¯ ---
            useEffect(() => {
                // 1. å…ˆçœ‹ç¾åœ¨é€™å€‹ç‰ˆæœ¬æœ‰æ²’æœ‰è³‡æ–™
                const current = localStorage.getItem(STORAGE_KEY);
                
                if (current) {
                    try { setData(JSON.parse(current)); } catch (e) { console.error(e); }
                } else {
                    // 2. å¦‚æœæ²’æœ‰ï¼Œé–‹å§‹æ‰¾èˆŠç‰ˆæœ¬çš„è³‡æ–™ (Legacy)
                    let foundLegacy = false;
                    for (const legacyKey of LEGACY_KEYS) {
                        const legacyData = localStorage.getItem(legacyKey);
                        if (legacyData) {
                            try {
                                const parsed = JSON.parse(legacyData);
                                if (parsed && parsed.transactions) {
                                    // æ‰¾åˆ°èˆŠè³‡æ–™äº†ï¼ç¹¼æ‰¿éä¾†
                                    setData(parsed);
                                    foundLegacy = true;
                                    break; // æ‰¾åˆ°æœ€è¿‘çš„ä¸€å€‹å°±åœ
                                }
                            } catch(e) {}
                        }
                    }
                    // 3. å¦‚æœæœ‰æ¬å®¶æˆåŠŸï¼Œè·³å‡ºé€šçŸ¥
                    if (foundLegacy) {
                        setTimeout(() => {
                            setModals(p => ({...p, updateNotice: true}));
                        }, 1000);
                    }
                }
                setIsLoaded(true);
            }, []);

            useEffect(() => { if (isLoaded) localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }, [data, isLoaded]);
            
            const changeMonth = (delta) => {
                const [year, month] = selectedMonth.split('-').map(Number);
                const date = new Date(year, month - 1 + delta, 1);
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                setSelectedMonth(`${y}-${m}`);
            };
            
            const { bankBalance, totalIncome, totalExpense, netSavings, totalDaily, monthlyTransactions, trendData } = useMemo(() => {
                let bal = data.settings.initialBalance;
                let tInc = 0, tExp = 0, tDaily = 0;
                
                data.transactions.forEach(t => {
                    if (t.type === 'income') { if (t.isBankAffected) bal += t.amount; } 
                    else { if (t.isBankAffected) bal -= t.amount; }
                });

                const mTrans = data.transactions.filter(t => t.date.startsWith(selectedMonth));
                mTrans.forEach(t => {
                    if (t.type === 'income') {
                        tInc += t.amount;
                    } else {
                        if (t.isBankAffected) tExp += t.amount; else tDaily += t.amount;
                    }
                });

                const monthKeys = [];
                for(let i=5; i>=0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    monthKeys.push(d.toISOString().slice(0, 7)); 
                }
                
                const trendMap = {};
                monthKeys.forEach(m => trendMap[m] = { name: m.slice(5)+'æœˆ', income: 0, expense: 0, savings: 0 });

                data.transactions.forEach(t => {
                   const m = t.date.slice(0, 7);
                   if (trendMap[m]) {
                       if (t.type === 'income') trendMap[m].income += t.amount;
                       else if (t.isBankAffected) trendMap[m].expense += t.amount; 
                   }
                });

                const finalTrendData = Object.values(trendMap).map(d => ({
                    ...d,
                    savings: d.income - d.expense
                }));

                return { bankBalance: bal, totalIncome: tInc, totalExpense: tExp, netSavings: tInc - tExp, totalDaily: tDaily, monthlyTransactions: mTrans, trendData: finalTrendData };
            }, [data, selectedMonth]); 

            const displayedTransactions = useMemo(() => {
                return monthlyTransactions.filter(t => {
                    if (filterType === 'all') return true;
                    if (filterType === 'income') return t.type === 'income';
                    if (filterType === 'payment') return t.type === 'expense' && t.isBankAffected;
                    if (filterType === 'daily') return t.type === 'expense' && !t.isBankAffected;
                    return true;
                });
            }, [monthlyTransactions, filterType]);
            const handleStart = () => {
                setShowSplash(false);
                if (data.settings.initialBalance === INITIAL_BANK_BALANCE_DEFAULT && data.transactions.length === 0) setModals(p => ({ ...p, setting: true }));
            };
            const handleSaveTrans = (newTrans) => {
                const type = newTrans.currentTab === 'income' ? 'income' : 'expense';
                const isBankAffected = newTrans.currentTab !== 'expense'; 
                const transObj = { ...newTrans, type, isBankAffected };
                const newTransactions = data.transactions.filter(t => t.id !== transObj.id).concat(transObj).sort((a, b) => new Date(b.date) - new Date(a.date));
                setData(prev => ({ ...prev, transactions: newTransactions }));
                setModals(prev => ({ ...prev, add: false, edit: null }));
                if (!data.transactions.find(t => t.id === transObj.id)) {
                    const qType = newTrans.currentTab === 'income' ? 'income' : (newTrans.currentTab === 'payment' ? 'payment' : 'expense');
                    setModals(prev => ({ ...prev, msg: getRandomQuote(qType) }));
                }
            };
            const handleDeleteTrans = (id) => {
                setData(prev => ({ ...prev, transactions: prev.transactions.filter(t => t.id !== id) }));
                setModals(prev => ({ ...prev, edit: null }));
            };

            // è™•ç†è‡ªå‹•å‚™ä»½ä¸‹è¼‰ (å¾é€šçŸ¥è¦–çª—è§¸ç™¼)
            const handleAutoBackup = () => {
                const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a'); 
                a.href = url; a.download = `å¯Œå©†å¸³æœ¬_è‡ªå‹•æ¬å®¶å‚™ä»½_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                setModals(p => ({...p, updateNotice: false}));
            };

            if (!isLoaded) return null;
            if (showSplash) return <SplashScreen onStart={handleStart} customImage={data.settings.customImage} />;

            return (
                <div className={`font-sans pb-24 text-gray-800 h-full w-full overflow-y-auto bg-[#f2ede7]`}>
                    <div className="pt-8 px-6 pb-4 flex justify-between items-center max-w-screen-md mx-auto">
                        <div><h1 className={`text-3xl font-black tracking-tight ${THEME.text}`}>RICH LADY</h1><p className="text-sm font-bold text-gray-400 tracking-widest">å¯Œå©†è¨˜å¸³æœ¬ è¶ŠèŠ±è¶Šæœ‰éŒ¢</p></div>
                        <div className="flex gap-2">
                            <button onClick={() => setViewMode(viewMode === 'list' ? 'chart' : 'list')} className={`flex items-center gap-1 px-3 py-3 bg-[#f7b7a7] text-[#2c2c2c] border-2 ${THEME.border} rounded-xl ${THEME.shadowSm} ${THEME.shadowActive} transition-all font-bold text-sm`}>
                                {viewMode === 'list' ? <PieIcon size={18}/> : <Layers size={18}/>}
                                <span className="hidden sm:inline">åˆ†æ</span>
                            </button>
                            <button onClick={() => setModals(p => ({...p, backup: true}))} className={`p-3 bg-[#7696b8] text-white border-2 ${THEME.border} rounded-xl ${THEME.shadowSm} ${THEME.shadowActive} transition-all`}>
                                <Save size={20}/>
                            </button>
                            <button onClick={() => setModals(p => ({...p, setting: true}))} className={`p-3 bg-[#2c2c2c] text-white rounded-xl ${THEME.shadowSm} ${THEME.shadowActive}`}><Settings size={20}/></button>
                        </div>
                    </div>
                    <div className="px-6 mb-6 max-w-screen-md mx-auto">
                        <div onClick={() => setModals(p=>({...p, cal: true}))} className={`relative p-6 ${THEME.bank.main} rounded-[2rem] border-4 ${THEME.border} ${THEME.shadow} cursor-pointer group overflow-hidden`}>
                            <div className="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10"></div>
                            <div className="relative z-10">
                                <div className="flex justify-between items-start mb-2"><p className="text-blue-100 font-bold tracking-wider text-sm">é‡‘åº«ç¸½é¡</p><Hash className="text-blue-200 w-5 h-5 group-hover:rotate-12 transition-transform" /></div>
                                <div className="flex items-baseline gap-3"><h2 className="text-4xl font-black text-white tracking-tighter">{showBalance ? `$${bankBalance.toLocaleString()}` : '****'}</h2><button onClick={(e) => { e.stopPropagation(); setShowBalance(!showBalance); }} className="p-1 text-blue-200 hover:text-white">{showBalance ? <EyeOff size={20}/> : <Eye size={20}/>}</button></div>
                            </div>
                        </div>
                    </div>
                    <div className="px-6 mb-4 flex justify-between items-center max-w-screen-md mx-auto">
                        <button onClick={() => changeMonth(-1)} className={`p-2 bg-white border-2 ${THEME.border} rounded-lg ${THEME.shadowSm}`}><ChevronLeft size={20}/></button>
                        <span className="font-black text-xl text-[#2c2c2c] tracking-widest">{selectedMonth}</span>
                        <button onClick={() => changeMonth(1)} className={`p-2 bg-white border-2 ${THEME.border} rounded-lg ${THEME.shadowSm}`}><ChevronRight size={20}/></button>
                    </div>
                    <div className="grid grid-cols-2 gap-3 px-6 mb-8 max-w-screen-md mx-auto">
                        <div className={`p-3 ${THEME.income.main} rounded-2xl border-2 ${THEME.border} ${THEME.shadowSm}`}>
                            <p className="text-xs font-bold mb-1 opacity-80 text-white">æœ¬æœˆæ”¶å…¥</p>
                            <p className="font-black text-lg leading-none text-white">+${totalIncome.toLocaleString()}</p>
                        </div>
                        <div className={`p-3 ${THEME.payment.main} rounded-2xl border-2 ${THEME.border} ${THEME.shadowSm}`}>
                            <p className="text-xs font-bold text-[#2c2c2c] mb-1 opacity-90">æœ¬æœˆç¹³è²»</p>
                            <p className="font-black text-lg leading-none text-[#2c2c2c]">-${totalExpense.toLocaleString()}</p>
                        </div>
                        <div className={`p-3 ${THEME.daily.main} rounded-2xl border-2 ${THEME.border} ${THEME.shadowSm}`}>
                            <p className="text-xs font-bold text-[#2c2c2c] mb-1 opacity-90">éš¨æ‰‹è¨˜ (ä¸è¨ˆå…¥)</p>
                            <p className="font-black text-lg leading-none text-[#2c2c2c]">${totalDaily.toLocaleString()}</p>
                        </div>
                        <div className={`p-3 bg-white rounded-2xl border-2 ${THEME.border} ${THEME.shadowSm}`}>
                            <p className="text-xs font-bold text-gray-400 mb-1">æœ¬æœˆç¸½è¨ˆ</p>
                            <p className={`font-black text-lg leading-none ${netSavings >= 0 ? 'text-[#a1b89e]' : 'text-[#f7b7a7]'}`}>{netSavings >= 0 ? '+' : ''}{netSavings.toLocaleString()}</p>
                        </div>
                    </div>
                    <div className="px-6 max-w-screen-md mx-auto">
                        {viewMode === 'list' ? (
                            <div className="space-y-4 animate-in fade-in">
                                <div className="flex items-center justify-between">
                                    <h3 className={`font-black text-xl flex items-center gap-2 ${THEME.text}`}><span className="bg-[#2c2c2c] text-white px-2 py-1 text-sm rounded-md rotate-2">HISTORY</span> å¸³å‹™ç´€éŒ„</h3>
                                </div>
                                <div className="flex gap-2 overflow-x-auto pb-2 no-scrollbar">
                                    {['all', 'income', 'payment', 'daily'].map(type => (
                                        <button key={type} onClick={() => setFilterType(type)} className={`px-4 py-2 rounded-xl font-bold text-sm whitespace-nowrap border-2 transition-all ${filterType === type ? 'bg-[#2c2c2c] text-white border-[#2c2c2c] shadow-[2px_2px_0px_0px_rgba(0,0,0,0.2)]' : 'bg-white text-gray-400 border-gray-200'}`}>
                                            {type === 'all' ? 'å…¨éƒ¨' : type === 'income' ? 'æ”¶å…¥' : type === 'payment' ? 'ç¹³è²»' : 'éš¨æ‰‹è¨˜'}
                                        </button>
                                    ))}
                                </div>
                                {displayedTransactions.length === 0 ? 
                                <div className="text-center py-10 opacity-50"><p className="text-6xl mb-4">ğŸ›‹ï¸</p><p className="font-bold text-lg">{filterType === 'all' ? 'èººå¹³å°±èƒ½è®Šå¯Œå©†ï¼Ÿå…ˆè¨˜ä¸€ç­†ï¼' : 'é€™å€‹é¡åˆ¥é‚„æ²’æœ‰ç´€éŒ„å–”ï½'}</p></div> 
                                : displayedTransactions.map(t => <TransactionItem key={t.id} transaction={t} onClick={(item) => setModals(p => ({...p, edit: item}))} />)}
                            </div>
                        ) : (
                            <div className={`bg-white p-6 rounded-[2rem] border-4 ${THEME.border} min-h-[400px] ${THEME.shadow} flex flex-col animate-in fade-in`}>
                                <h3 className="text-center font-black text-xl mb-4 border-b-2 border-gray-100 pb-2">å¯Œå©†çš„é¤Šæˆè¨ˆç•«</h3>
                                <div className="h-72 w-full relative">
                                    <ResponsiveContainer width="100%" height="100%">
                                        <ComposedChart data={trendData} margin={{ top: 20, right: 10, left: -20, bottom: 0 }}>
                                            <XAxis dataKey="name" tick={{fontSize: 10, fontWeight: 'bold'}} axisLine={false} tickLine={false} />
                                            <YAxis hide />
                                            <RechartsTooltip contentStyle={{borderRadius: '16px', border: '3px solid #2c2c2c', boxShadow: '4px 4px 0 #2c2c2c', fontWeight: 'bold'}} />
                                            <Legend verticalAlign="bottom" height={36}/>
                                            <Bar dataKey="income" name="æ”¶å…¥" fill="#a1b89e" radius={[4, 4, 0, 0]} barSize={20} />
                                            <Bar dataKey="expense" name="ç¹³è²»" fill="#f7b7a7" radius={[4, 4, 0, 0]} barSize={20} />
                                            <Line type="monotone" dataKey="savings" name="ç›ˆé¤˜" stroke="#debe51" strokeWidth={3} dot={{r: 4, strokeWidth: 2, fill: 'white'}}>
                                                <LabelList 
                                                    dataKey="savings" 
                                                    position="top" 
                                                    offset={10} 
                                                    style={{fill: '#2c2c2c', fontWeight: 'bold', fontSize: '12px'}} 
                                                    formatter={(val) => val > 0 ? `+${val.toLocaleString()}` : val.toLocaleString()}
                                                />
                                            </Line>
                                        </ComposedChart>
                                    </ResponsiveContainer>
                                </div>
                                <p className="text-center text-xs text-gray-400 font-bold mt-2">* éš¨æ‰‹è¨˜(ç¾é‡‘)ä¸è¨ˆå…¥æ­¤åœ–è¡¨</p>
                            </div>
                        )}
                    </div>
                    <button onClick={() => setModals(p => ({...p, add: true}))} className={`fixed bottom-8 right-6 w-16 h-16 bg-[#2c2c2c] text-white rounded-full flex items-center justify-center shadow-[4px_4px_0px_0px_rgba(0,0,0,0.3)] hover:scale-110 hover:rotate-90 transition-all duration-300 z-40 border-4 border-white`}><Plus size={32} strokeWidth={3} /></button>
                    <div className="text-center mt-8 pb-4 text-xs font-bold text-gray-400 transition-colors">
                        <div className="flex flex-col items-center gap-2">
                            <div className="flex items-center justify-center gap-3">
                                <a href="https://lazymeg.com/m/" target="_blank" className="hover:text-[#f7b7a7] transition-colors">Designed by meg.dai</a>
                                <span className="text-gray-300">|</span>
                                <a href="https://www.instagram.com/lazy2meg/" target="_blank" className="hover:scale-110 hover:text-[#f7b7a7] transition-all"><Instagram size={16}/></a>
                            </div>
                            <p className="text-[10px] text-gray-400">æœ€è¿‘æ›´æ–° 2025/11/25</p>
                        </div>
                    </div>
                    {modals.updateNotice && <UpdateNoticeModal onBackup={handleAutoBackup} onClose={() => setModals(p => ({...p, updateNotice: false}))} />}
                    {modals.msg && <MotivationalPopup message={modals.msg} customImage={data.settings.customImage} onClose={() => setModals(p => ({...p, msg: null}))} />}
                    {(modals.add || modals.edit) && <TransactionModal initialData={modals.edit} onClose={() => setModals(p => ({...p, add: false, edit: null}))} onSave={handleSaveTrans} onDelete={handleDeleteTrans} categories={{income: data.settings.incomeCategories, expense: data.settings.expenseCategories, bank: data.settings.bankExpenseCategories}} />}
                    {modals.setting && <SettingsModal data={data} updateData={setData} onClose={() => setModals(p => ({...p, setting: false}))} />}
                    {modals.backup && <BackupModal data={data} updateData={setData} onClose={() => setModals(p => ({...p, backup: false}))} />}
                    {modals.cal && <CalculatorModal initialValue={0} onClose={() => setModals(p => ({...p, cal: false}))} />}
                </div>
            );
        };
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
